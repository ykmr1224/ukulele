<html lang="en">
<head>
    <script src="//code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <script src="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"
          integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog=="
          crossorigin="anonymous"/>
    <title>Ukulele</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-color: white;
            padding: 10px;
        }
        canvas {
            display: block;
        }
        @media print {
            .no-print, .no-print * {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<canvas id="backCanvas" width="0" height="0"></canvas>
<div id="wrapper" style="background-color: white;">
    <h2 id="song-title"></h2>
    <div class="btn-group-toggle no-print" data-toggle="buttons">
        <label class="btn btn-sm btn-info">
            <input type="checkbox" autocomplete="off" id="autoScroll"> Auto Scroll
        </label>
    </div>
    <div id="lines"></div>
</div>
<div class="no-print">
    <hr>
    <form action="./index.html">
        <div class="form-group">
            <label for="title">Title:</label>
            <input type="text" class="form-control" placeholder="title" id="title" name="title">
        </div>
        <div class="form-group">
            <label for="chords">Chords:</label>
            <textarea class="form-control" id="chords" rows="6" name="chords"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>
<script lang="javascript">
  const DEFAULT_CHORD = [0,0,0,0];
  const CHORDS = {
    C: '3000',
    Cm: '3330',
    C7: '1000',
    Cm7: '3333',
    Cdim: '3232',
    'C#': '4111',
    'C#m': '4441',
    'C#7': '2111',
    'C#m7': '2011',
    'C#dim': '1010',
    Df: '4111',
    Dfm: '4441',
    Df7: '2111',
    Dfm7: '2011',
    Dfdim: '1010',
    D: '0222',
    Dm: '0122',
    D7: '0202', // Gazlele code
    Dm7: '3122',
    Ddim: '2121',
    'D#': '1330',
    'D#m': '1233',
    'D#7': '4333',
    'D#m7': '4233',
    'D#dim': '3232',
    Ef: '1330',
    Efm: '1233',
    Ef7: '4333',
    Efm7: '4233',
    Efdim: '3232',
    E: '2444',
    Em: '2340',
    E7: '2021',
    Em7: '2020',
    Edim: '1010',
    F: '0102',
    Fm: '3101',
    F7: '3132',
    Fm7: '3131',
    Fdim: '2121',
    'F#': '1213',
    'F#m': '0212',
    'F#7': '4243',
    'F#m7': '4242',
    'F#dim': '3232',
    Gf: '1213',
    Gfm: '0212',
    Gf7: '4243',
    Gfm7: '4242',
    Gfdim: '3232',
    G: '2320',
    Gm: '1320',
    G7: '2120',
    Gm7: '1120',
    Gdim: '1010',
    'G#': '3435',
    'G#m': '2431',
    'G#7': '3231',
    'G#m7': '2231',
    'G#dim': '2121',
    Af: '3435',
    Afm: '2431',
    Af7: '3231',
    Afm7: '2231',
    Afdim: '2121',
    A: '0012',
    Am: '0002',
    A7: '0010',
    Am7: '0000',
    Adim: '3232',
    'A#': '1123',
    'A#m': '1113',
    'A#7': '1121',
    'A#m7': '1111',
    'A#dim': '1010',
    Bf: '1123',
    Bfm: '1113',
    Bf7: '1121',
    Bfm7: '1111',
    Bfdim: '1010',
    B: '2234',
    Bm: '2224',
    B7: '2232',
    Bm7: '2222',
    Bdim: '2121',
  };

  const STYLE = {
    bgColor: '#ffffff',
    lyricsSize: 24,
    lyricsColor: '#222222',
    lyricsHeight: 40,
    chordTextSize: 32,
    chordTextColor: '#222222',
    chordTextHeight: 40,
    chordColor: '#444444',
    chordUnit: 24,
    padding: 20,
    chordSpacing: 12,
  };

  class Chords {
    static deserializeFingers(str) {
      let result = [...DEFAULT_CHORD];
      for (let i=0; i<4 && i<str.length; i++) {
        result[i] = str[i] - '0';
      }
      return result;
    }

    static extractChord(chordStr) {
      return chordStr.match(/^[A-Z][a-z0-9#]*/);
    }

    static get(chordStr) {
      let chord = Chords.extractChord(chordStr);
      return Chords.deserializeFingers(CHORDS[chord] || DEFAULT_CHORD);
    }
  }

  class Drawer {
    constructor(ctx) {
      this.ctx = ctx;
      this.font = 'Helvetica';
    }

    fillStyle(style) {
      this.ctx.fillStyle = style;
    }

    strokeStyle(style, width) {
      this.ctx.strokeStyle = style;
      this.ctx.strokeWidth = width | 1;
      this.ctx.lineWidth = width | 1;
      this.ctx.lineCap = 'round';
    }

    fillRect(x, y, w, h) {
      this.ctx.fillRect(x, y, w, h);
    }

    strokeRect(x, y, w, h) {
      this.ctx.strokeRect(x, y, w, h);
    }

    fillOval(cx, cy, rx, rh) {
      this.ctx.beginPath();
      this.ctx.ellipse(cx, cy, rx, rh, 0, 0, 2 * Math.PI);
      this.ctx.fill();
    }

    line(x0, y0, x1, y1) {
      this.ctx.beginPath();
      this.ctx.moveTo(x0, y0);
      this.ctx.lineTo(x1, y1);
      this.ctx.stroke();
    }

    text(str, x, y, fontSize) {
      this.ctx.font = `${fontSize}pt ${this.font}`;
      this.ctx.fillText(str, x, y);
      return this.ctx.measureText(str).width;
    }
  }

  class ChordDrawer extends Drawer {
    constructor(canvas) {
      super(canvas.getContext('2d'));
    }

    clear(width, height) {
      this.fillStyle(STYLE.bgColor);
      this.fillRect(0,0,width,height);
    }

    drawChord(chord, x, y, unit) {
      this.strokeStyle(STYLE.chordColor, 2);

      let hspan = unit;
      let wspan = unit;
      let fingers = Chords.get(chord);
      let max = Math.max(3, Math.max(...fingers));
      let lines = 4;

      y += Math.floor(hspan/2);
      for (let i = 0; i < lines; i++) {
        this.line(x, y + hspan * i, x + max * unit, y + hspan * i);
      }

      for (let i = 0; i <= max; i++) {
        this.line(x + wspan * i, y, x + wspan * i, y + hspan * 3);
      }
      this.line(x + wspan * 0.1, y, x + wspan * 0.1, y + hspan * 3);

      let r = (wspan * 0.7) / 2;
      this.fillStyle(STYLE.chordColor);
      for (let i = 0; i < lines; i++) {
        if (fingers[i] > 0) {
          let fingerX = x - wspan / 2 + fingers[i] * wspan;
          let fingerY = y + i * hspan;
          this.fillOval(fingerX, fingerY, r, r);
        }
      }
      return [max * unit, unit * 4];
    }

    drawBar(lyrics, chords, x, y, unit, careLyricsWidth) {
      let space = unit;
      let x1 = x;
      let y1 = y;
      this.fillStyle(STYLE.chordTextColor, 1);
      this.text('/', x1, y1 + STYLE.lyricsHeight + STYLE.chordTextSize, STYLE.chordTextSize);
      x1 += unit;
      for (let i=0; i<chords.length; i++) {
        let lyricsWidth = this.text(lyrics[i]||'', x1, y1 + STYLE.lyricsSize, STYLE.lyricsSize);
        let chordTextWidth = this.text(chords[i], x1, y1 + STYLE.lyricsHeight + STYLE.chordTextSize, STYLE.chordTextSize);
        let chordWidth = this.drawChord(chords[i], x1, y1 + STYLE.lyricsHeight + STYLE.chordTextHeight, unit)[0];
        x1 += Math.max(careLyricsWidth ? lyricsWidth : 0, chordTextWidth, chordWidth) + space;
      }
      return [x1 - x, y1 + STYLE.lyricsHeight + STYLE.chordTextHeight + unit*4 - y];
    }
  }

  let parseBar = (inputBar) => {
    return inputBar.split(',');
  }

  let removeEmpty = (arr) => {
    if (arr[0] !== undefined && arr[0].length === 0) {
      arr.splice(0, 1);
    }
    if (arr.length > 0 && arr[arr.length-1].length === 0) {
      arr.splice(arr.length-1, 1);
    }
  };

  let parseChords = (inputBars) => {
    let bars = inputBars.trim().split('/');
    removeEmpty(bars);
    return $.map(bars, (inputBar) => [parseBar(inputBar)]);
  };

  let parseLyrics = (inputLyrics) => {
    let lyrics = inputLyrics.trim().split('/');
    removeEmpty(lyrics);
    return $.map(lyrics, (input) => [input.split(',')]);
  };

  let parseInput = (input) => {
    let lines = input.split('\n');
    let result = {
      lyrics: [],
      bars: []
    }
    for (let i=0; i<Math.floor(lines.length/2); i++) {
        result.lyrics.push(parseLyrics(lines[i*2]));
        result.bars.push(parseChords(lines[i*2+1]));
    }
    return result;
  };

  let getAllChords = (canvas, chord) => {
    let mains = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    let suffix = ['', 'm', '7', 'm7', 'dim'];

    let result = [];
    for (let i=0; i<mains.length; i++) {
      let chords = []
      for (let j=0; j<suffix.length; j++) {
        chords.push(mains[i] + suffix[j]);
      }
      result.push(chords);
    }
    return result;
  };

  let drawLine = (chordDrawer, lyrics, bar) => {
    chordDrawer.clear();
    let y = STYLE.padding;
    let x = STYLE.padding;
    let height = 0;
    for (let j=0; j<bar.length; j++) {
      let size = chordDrawer.drawBar(lyrics[j]||[], bar[j]||[], x, y, STYLE.chordUnit, lyrics.length > 1);
      x += size[0];
      height = size[1];
    }
    y += height;
    return [x + STYLE.padding, y + STYLE.padding];
  };

  class AutoScroll {
    start(interval, unit) {
      this.stop();
      this.handle = window.setInterval(() => {
        window.scrollBy(0, unit);
      }, interval);
    }
    stop() {
      if (this.handle !== undefined) {
        window.clearInterval(this.handle);
        this.handle = undefined;
      }
    }
  }

  let update = (title, chords) => {
    $(`#song-title`).html(title);
    document.title = 'Ukulele: ' + title;

    let $lines = $('#lines');
    $lines.html('');

    let data = parseInput(chords);
    let $backCanvas = $('#backCanvas');
    let backDrawer = new ChordDrawer($backCanvas[0]);
    for (let i=0; i<data.bars.length; i++) {
      let size = drawLine(backDrawer, data.lyrics[i], data.bars[i]);
      let $canvas = $(`<canvas width="${size[0]}" height="${size[1]}"></canvas>`).appendTo($lines);
      $canvas.css('width', size[0]/2);
      $canvas.css('height', size[1]/2);
      drawLine(new ChordDrawer($canvas[0]), data.lyrics[i], data.bars[i]);
    }
  };

  $(function () {
    let params = new URLSearchParams(window.location.search);
    let title = decodeURIComponent(params.get('title'));
    let chords = decodeURIComponent(params.get('chords').replace(/\+/g, ' '));
    $('#chords').val(chords);
    $('#title').val(title);

    update(title, chords);

    let autoScroll = new AutoScroll();
    let autoScrollButton = $('#autoScroll');
    autoScrollButton.on('change', () => {
      if (autoScrollButton.prop('checked')) {
        autoScroll.start(500, 5);
      } else {
        autoScroll.stop();
      }
    });
  });
</script>
</body>
</html>